# reactå¼‚æ­¥åˆ†ç‰‡è®¡ç®—åœ¨è¯äº‘çš„å®è·µ
![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/fm.png#pic_center)

> é¡¹ç›®ä»£ç ï¼šhttps://github.com/blazer233/algorithm-learn/tree/main/wordcloud
> 


## èƒŒæ™¯

åœ¨å°ç¨‹åºå¼€å‘çš„æ—¶å€™ï¼Œé‡åˆ°ä¸€ä¸ªéœ€è¦å±•ç¤ºè¯äº‘çš„æ¨¡å—


![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/sjg.png)

ç¬¬ä¸€ååº”æ˜¯å» `npm` æœä¸€ä¸‹æœ‰æ²¡æœ‰å¯¹åº”çš„åº“å¯ä»¥ç”¨ï¼Œ`echarts-wordcloud` ã€`wordcloud2` éƒ½å¯ä»¥å®ç°æƒ³è¦çš„æ•ˆæœï¼Œä½†æ˜¯å°ç¨‹åºæ¯•ç«Ÿå®¹é‡æœ‰é™ï¼Œè€Œä¸”æˆ‘ä»¬åªæƒ³å®ç°çš„è¯äº‘åŠŸèƒ½åˆæ¯”è¾ƒç®€å•ï¼Œä¸ºäº†ä»…ä»…ä¸€ä¸ªæ¨¡å—çš„åŠŸèƒ½å¼•å…¥ä¸€æ•´ä¸ªnpmåŒ…ï¼Œæ˜¾å¾—æœ‰äº›æ€é¸¡ç”¨ç‰›åˆ€ï¼Œäºæ˜¯ç¬¬ä¸€æ—¶é—´æ‰’ä¸‹ `wordcloud2` æºç ï¼Œç…ç…æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œèƒ½ä¸èƒ½æä¸ªå·®ä¸å¤šçš„äºæ˜¯ï¼š

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/wc2.png#pic_center)

è¿™å››å±‚whileå¾ªç¯ï¼Œçœ‹çš„æˆ‘æ˜¯ä¸€è„¸æ‡µé€¼...  æ—¢ç„¶æˆ‘ä»¬å®ç°çš„å¹¶éå¤æ‚çš„è¯äº‘ï¼Œä¸ºä»€ä¹ˆä¸èƒ½è‡ªå·±æä¸€ä¸ªå‘¢

äºæ˜¯ç½‘ä¸Šæ‰¾äº†æ‰¾èµ„æ–™ï¼Œè‡ªå·±ä¸€ç‚¹ç‚¹æ¢ç´¢å®ç°äº†ä¸€ä¸ªç®€å•çš„è¯äº‘åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨åŠŸèƒ½å®ç°çš„åŸºç¡€ä¸Šåˆå¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚

## å¸ƒå±€

å¯¹äºè¯äº‘è€Œè¨€ï¼Œæœ€é‡è¦çš„å°±æ˜¯å¸ƒå±€ï¼Œè€Œæˆ‘ä»¬æƒ³è¦çš„å¸ƒå±€æ˜¯ï¼š

- ä»¥ä¸­å¿ƒä¸ºèµ·å§‹ç‚¹ï¼Œé€æ¸ä»¥ç¯å½¢å‘å¤–å›´æ‰©å±•ï¼Œæ–‡å­—ç”±å¤§åˆ°å°ä»ä¸­é—´åˆ°å¤–å›´æƒé‡é€æ¸é€’å‡ï¼Œå½¢æˆä¸€ä¸ªæ¤­åœ†å½¢çš„æ•ˆæœã€‚

è¿™ä¹ˆè®²å¯èƒ½ä¸€è„¸æ‡µï¼Œä½†æ˜¯æ¢ä¸ªæ–¹å¼è¡¨è¿°ï¼Œä¹Ÿå°±æ˜¯å°†æ–‡å­—æŒ‰ç…§ `æƒé‡/å¤§å°` çš„æ–¹å¼æŒ‰ç…§é¡ºåºæ’åºï¼Œé‚£ä¹ˆè¿™ç§é¡ºåºæ˜¯ä»€ä¹ˆå‘¢

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/iknow.png)
![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/wenxiang.png#pic_right)

**èšŠé¦™ï¼**

é«˜ç«¯çš„ç®—æ³•ï¼Œçµæ„Ÿå¾€å¾€æ¥æºæœ´ç´ çš„ç”Ÿæ´»ï¼ŒèšŠé¦™å®Œç¾ç¬¦åˆæˆ‘ä»¬éœ€è¦çš„å¸ƒå±€ï¼Œè€Œä¸”æåˆ°èšŠé¦™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡é˜¿åŸºç±³å¾·èºçº¿è¿›è¡Œç»˜åˆ¶ï¼Œè¿™æ ·åªéœ€è¦å°†æ’åºå¥½çš„æ–‡å­—ä¸€ä¸ªä¸ªæ”¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œä¾¿å¯å‘ˆç°å‡ºè¯äº‘çš„æ•ˆæœ

é¦–å…ˆåˆ©ç”¨ `é˜¿åŸºç±³å¾·èºçº¿æ–¹ç¨‹` ç®—å‡ºæ¯ä¸ªç‚¹çš„åæ ‡ä½ç½®ï¼Œç„¶ååœ¨æ•´ä¸ª `canvas` ç”»å¸ƒä¸Šè°ƒæ•´æ­¥é•¿å’Œèºè·ç»˜åˆ¶å‡ºåæ ‡ç‚¹ï¼Œä¸”å¦‚æœè¶…å‡ºç”»å¸ƒå¤§å°æ—¶ `break` ã€‚æœ€ç»ˆå°†æ¯ä¸ªåæ ‡ç‚¹è¿›è¡Œè¿”å›ï¼Œä¹‹ååœ¨æ¯ä¸ªåæ ‡å¤„ç»˜åˆ¶æ–‡å­—ï¼Œè®©æ–‡å­—å‘ˆèºçº¿çš„æ–¹å‘ä¾æ¬¡æ’å¸ƒ

```js
/** é˜¿åŸºç±³å¾·èºçº¿, ç”¨äºåˆå§‹åŒ–ä½ç½®å‡½æ•°, è°ƒç”¨åè¿”å›ä¸€ä¸ªè·å–ä½ç½®çš„å‡½æ•°
 * @param {*} size ç”»å¸ƒå¤§å°, [width, height]
 * @param {*} { step = 0.1, b = 1, a = 0 }  æ­¥é•¿(å¼§åº¦), èºè·, èµ·å§‹ç‚¹è·ä¸­å¿ƒçš„è·ç¦»
 * @returns
 */
export const archimedeanSpiral = (size, tmp = { step = 0.1, b = 1, a = 0 }) => {
  const e = size[0] / size[1]; // æ ¹æ®ç”»å¸ƒé•¿å®½æ¯”ä¾‹è¿›è¡Œå¯¹åº”ç¼©æ”¾
  // å‚æ•°tä¸ºå½“å‰å¼§åº¦å€¼
  return function (t) {
    return [e * (a + b * (t *= step)) * Math.cos(t), (a + b * t) * Math.sin(t)];
  };
};

```

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/ring.png#pic_center)

åˆ©ç”¨æ–¹ç¨‹è®¡ç®—æ¯ä¸ªè¯æ±‡çš„åæ ‡å¹¶ä¾æ¬¡åœ¨canvasæ¸²æŸ“å‡ºæ¥

```js
/**
 * è®¡ç®—æ‰€æœ‰èºçº¿ç‚¹
 * @param {*} size ç”»å¸ƒå¤§å°
 */
export const getAllPoints = (size) => {
  const getPosition = archimedeanSpiral(size);
  const points = [];
  let maxDelta = Math.sqrt(size[0] * size[0] + size[1] * size[1]), // æœ€å¤§åŠå¾„ï¼ˆå‹¾è‚¡å®šç†ï¼‰
    t = 1, // é˜¿åŸºç±³å¾·å¼§åº¦
    dxdy,
    dx, // xåæ ‡
    dy, // yåæ ‡
    x,
    y;
  // é€šè¿‡æ¯æ¬¡å¢åŠ çš„æ­¥é•¿å›ºå®šä¸º1ï¼Œå®é™…æ­¥é•¿ä¸º step * 1ï¼Œæ¥è·å–ä¸‹ä¸€ä¸ªæ”¾ç½®ç‚¹
  do {
    dxdy = getPosition(t);
    dx = dxdy[0];
    dy = dxdy[1];
    x = dx + size[0] / 2;
    y = dy + size[1] / 2;
    t++;
    if (Math.min(Math.abs(dx), Math.abs(dy)) >= maxDelta) break; // (dx, dy)è·ç¦»ä¸­å¿ƒè¶…è¿‡maxDeltaï¼Œè·³å‡ºèºæ—‹è¿”å›false
    points.push({ dx, dy, x, y });
  } while (true);
  return points;
};
```

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/txt-ring.png#pic_center)



## ç¢°æ’

å¸ƒå±€ä¼¼ä¹æ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ”¾å…¥æ–‡å­—ä¹‹åï¼Œå¦ä¸€ä¸ªé—®é¢˜å°±å‡ºç°äº†ï¼Œç”±äºæ²¡æœ‰è€ƒè™‘æ–‡å­—ç¢°æ’çš„é—®é¢˜ï¼Œè¶Šæ˜¯ä¸­å¿ƒçš„æ–‡å­—è¶Šä¼šå åœ¨ä¸€èµ·

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/pengzhaung-has.png#pic_center)

ç¢°æ’ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸¤ä¸ªç‰©ä½“ç¢°æ’åœ¨äº†ä¸€èµ·ï¼Œçœ¼ç›æ˜¯å¯ä»¥ç›´è§‚çš„è§‚å¯Ÿåˆ°ç¢°æ’çš„å‘ç”Ÿã€‚ä½†å¯¹äºå‰ç«¯å®ç°ï¼Œå¦‚ä½•è®© JavaScript ä»£ç ç†è§£ä¸¤ä¸ªç‹¬ç«‹çš„â€œç‰©ä½“â€ï¼ˆDOMï¼‰ç¢°æ’åœ¨ä¸€èµ·å‘¢ã€‚è¿™å°±æ¶‰åŠåˆ°ç¢°æ’æ£€æµ‹ï¼ˆæˆ–è€…å«è¾¹ç•Œæ£€æµ‹ï¼‰çš„é—®é¢˜äº†ï¼Œå¥½åœ¨æ­¤å¤„æˆ‘ä»¬é»˜è®¤å°†æ¯ä¸ªè¯æ±‡éƒ½çœ‹ä½œæ˜¯ä¸€ä¸ªä¸ªé•¿æ–¹ä½“ï¼Œåªéœ€è¦ç®€å•çš„è®¡ç®—å°±å¯ä»¥è§£å†³

å¯¹äºä¸¤ä¸ªæ–‡å­—æ˜¯å¦ç¢°æ’ï¼Œæœ‰å¦‚ä¸‹çš„åˆ¤æ–­æ¡ä»¶ï¼š

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/penzhuang.png#pic_center)


æ‰€ä»¥åº”è¯¥åœ¨æ¯ä¸ªè¯æ±‡è¿›è¡Œç»˜åˆ¶çš„æ—¶å€™è¿›è¡Œå¦‚ä¸‹æ£€æµ‹ï¼š

```js
/**
 *
 * @param {*} obj ç»˜åˆ¶çš„è¯æ±‡1
 * @param {*} obj2 ç»˜åˆ¶çš„è¯æ±‡2
 */
const hitTest = (obj = {}, obj2 = {}) => {
  var objW = obj.w; // å®½åº¦
  var objH = obj.h; // é«˜åº¦
  var objL = obj.x; //x åæ ‡
  var objT = obj.y; //y åæ ‡

  var obj2W = obj2.w;
  var obj2H = obj2.h;
  var obj2L = obj2.x;
  var obj2T = obj2.y;
  // true æ²¡ç¢°ä¸Š
  // false ç¢°ä¸Šäº†
  return (
    objL + objW < obj2L ||
    objT + objH < obj2T ||
    objL > obj2L + obj2W ||
    objT > obj2T + obj2H
  );
};
```

å¹¶ä¸”é™¤äº†æ–‡å­—ç¢°æ’ä¹‹å¤–ï¼Œè¿˜æœ‰è¾¹ç¼˜ç¢°å£çš„æƒ…å†µä¹Ÿè¦è€ƒè™‘åœ¨å†…

```js
/**
 *
 * @param {*} point ç»˜åˆ¶çš„æ–‡å­—åæ ‡ä¿¡æ¯
 * @param {*} size ç”»å¸ƒå°ºå¯¸
 */
export const outLineTest = (point, size) => {
  return (
    Number(point.x) + Number(point.w) > size[0] ||
    Number(point.y) + Number(point.h) > size[1]
  );
};
```

æ¯å½“ç»˜åˆ¶ä¸€ä¸ªè¯æ±‡æ—¶ï¼Œéƒ½éœ€è¦å°†å¾…ç»˜åˆ¶è¯æ±‡ä¸ä¹‹å‰æ’å¸ƒå®Œæˆçš„è¯æ±‡ä¾æ¬¡è¿›è¡Œç¢°æ’æ£€æµ‹ï¼Œä¸ºä»€ä¹ˆè¦ä¾æ¬¡æ£€æµ‹å‘¢ï¼Œåªæ£€æµ‹ä¸Šä¸€æ¬¡ç»˜åˆ¶çš„è¯æ±‡ä¸è¡Œå—ï¼Ÿè¿™æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¯æ±‡çš„å­—æ•°æ˜¯ä¸å¯æ§çš„ï¼Œæœ‰å¯èƒ½è¯æ±‡è¶…é•¿ï¼Œä¸ä¸Šä¸€ä¸ªæ–‡å­—æ²¡æœ‰é‡å ä½†æ˜¯ä¸å…¶ä»–æ–‡å­—æœ‰é‡å ã€‚


å¦‚æœåœ¨å¦‚ä¸Šçš„æ£€æµ‹ä¸­å­˜åœ¨ç¢°æ’ï¼Œåˆ™ç»§ç»­ç”¨èºçº¿ä¸Šå·²ç»˜åˆ¶åæ ‡çš„ä¸‹ä¸€ä¸ªå¾…ç»˜åˆ¶çš„åæ ‡ç‚¹ç»§ç»­æ£€æµ‹ï¼Œå¦‚æœè¯¥åæ ‡æ”¾ç½®æ–‡å­—æ—¶ï¼Œä¾ç„¶ä¼šä¸æ’å¸ƒå¥½çš„æ–‡å­—å‘ç”Ÿç¢°æ’çš„è¯ï¼Œå°±ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªåæ ‡ï¼Œç›´åˆ°æ£€æµ‹é€šè¿‡ï¼Œç¡®å®šå¥½å½“å‰çš„åæ ‡ï¼Œå°†å¾…ç»˜åˆ¶çš„è¯æ±‡æ¸²æŸ“åˆ°è¯¥åæ ‡ä½ç½®ã€‚

å¦‚å›¾ï¼Œé¡ºç€èºçº¿çš„è·¯å¾„è¿›è¡Œæ’å¸ƒï¼Œä¾æ¬¡æ”¾ç½®æ¯ä¸€ä¸ªè¯æ±‡

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/cs.png#pic_center)

ç›¸å½“äºä¸€ç§ç®€å•çš„ **æŒ‡é’ˆç®—æ³•**

```js
/**
 *
 * @param {*} ctx canvas å¯¹è±¡
 * @param {*} hasDrawText å·²ç»å¸ƒå±€å¥½çš„è¯æ±‡
 * @param {*} points èºçº¿çš„æ‰€æœ‰åæ ‡ä¿¡æ¯
 * @param {*} baseData æ‰€æœ‰è¯æ±‡çš„ç»˜åˆ¶åæ ‡ä¿¡æ¯
 * @param {*} i ç´¢å¼•
 * @param {*} isArea æ˜¯å¦ç»˜åˆ¶è¾¹æ¡†
 */
export default function handleItem(ctx, hasDrawText, points, baseData, i, isArea) {
  let point = baseData[i];
  ctx.fillStyle = point.color;
  ctx.font = point.fontSize + "px Arial";
  point.w = ctx.measureText(point.text).width;
  ctx.beginPath();
  if (hasDrawText.length) {
    let s = i;
    while (
      !hasDrawText.every( // ç¢°æ’æ£€æµ‹ è¾¹ç¼˜æ£€æµ‹
        one => hitTest(point, one) && !outLineTest(point, size)
      )
    ) {
      point = { ...point, ...points[s] };
      s++; // ç´¢å¼•è‡ªå¢å¯»æ‰¾å¯ä»¥é€šè¿‡æ£€æµ‹çš„åæ ‡
    }
  } else {
    point.x = point.x - point.w / 2;
    point.y = point.y - point.h / 2;
  }
  hasDrawText.push(point);
  // /*æ¸²æŸ“æ–‡å­—*/
  ctx.fillText(point.text, point.x, point.y + point.h);
}
```

åœ¨è§£å†³äº†å¸ƒå±€å’Œç¢°æ’ä¸¤ä¸ªå¤§é—®é¢˜ä¹‹åï¼Œæˆ‘ä»¬çš„éœ€æ±‚å·²ç»åšçš„å·®ä¸å¤šäº†ï¼Œè™½ç„¶æ˜¯å°ç¨‹åºçš„éœ€æ±‚ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨pcæ¨¡æ‹Ÿæ¼”ç¤ºä¸€ä¸‹

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/ciyun-over.png#pic_center)


## schedule

ä»£ç çš„ç»“æœå¦‚ä¸Šï¼Œä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œåœ¨æ¸²æŸ“æ•´ä¸ªè¯äº‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†æ¯ä¸ªåæ ‡ä¾æ¬¡æ‰¾åˆ°ã€æ¸²æŸ“ï¼Œå°¤å…¶æ˜¯åœ¨æ‰¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯æ¬¡å‡†å¤‡ç»˜åˆ¶çš„è¯æ±‡ä¸ä¹‹å‰æ‰€æœ‰çš„è¯æ±‡è¿›è¡Œç¢°æ’æ£€æµ‹ï¼Œè¿™ä¸€ç‚¹å¾ˆè€—æ—¶ï¼Œå½“æˆ‘ä»¬çš„è¯æ±‡è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªæŸ¥æ‰¾æ—¶é—´ä¹Ÿä¼šæˆå€å¢é•¿ï¼Œå¦‚ä¸‹æ˜¯æ¸²æŸ“100ä¸ªè¯æ±‡çš„ç«ç„°å›¾ï¼Œè°ƒç”¨æ ˆä¸€ç›´è¢« `handleItem` å æ®ï¼Œé¡µé¢ä¼šå‡ºç°ç™½å±ã€å¡é¡¿çš„æƒ…å†µ

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/bef.png#pic_center)

è¿™æ—¶å€™å°±éœ€è¦å¼•å…¥å¼‚æ­¥åˆ†ç‰‡æ¥è§£å†³

è¯´åˆ°å¼‚æ­¥åˆ†ç‰‡å°±ä¸å¾—ä¸æ `react schedule` ï¼Œreact å°±æ˜¯æ¨¡æ‹Ÿå‡ºæµè§ˆå™¨ `requestIdleCallback` å°†ä»»åŠ¡åˆ‡å‰²æˆæ— æ•°å°ä»»åŠ¡ï¼ŒæŠ¢ç©ºé—²æ—¶æœŸçš„ç©ºé—²æ—¶é—´åˆ†ç‰‡æ‰§è¡Œ

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/fiber.gif)

`react` å›¢é˜Ÿæ²¡æœ‰ç›´æ¥åˆ©ç”¨ `requestIdleCallback` æ˜¯å› ä¸ºè¿™ä¸ª `requestIdleCallback` åœ¨å„ä¸ªç‰ˆæœ¬çš„æµè§ˆå™¨å…¼å®¹æ€§è¾ƒå·®ï¼Œå…¶æ¬¡ï¼Œ`requestIdleCallback` å¹¶ä¸æ˜¯æ¯ä¸€å¸§éƒ½ä¼šæ‰§è¡Œï¼Œå®ƒåªä¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´çš„æ—¶å€™è¿›è¡Œæ‰§è¡Œï¼Œè€Œè¿™ä¸ª `ç©ºé—²æ—¶é—´` æ˜¯ä¸ç¨³å®šçš„ï¼Œå¦‚æœæµè§ˆå™¨ä¸€ç›´å¤„äºç¹å¿™çŠ¶æ€ï¼Œå¯¼è‡´æ¥å—çš„å›è°ƒä¸€ç›´æ— æ³•æ‰§è¡Œï¼Œæˆ‘ä»¬è™½ç„¶å¯ä»¥åˆ©ç”¨ `requestIdleCallback` çš„ç¬¬äºŒä¸ªå‚æ•° `timeout` ,ä½†æ˜¯å¦‚æœæ˜¯å› ä¸ºtimeoutå›è°ƒæ‰å¾—ä»¥æ‰§è¡Œçš„è¯ï¼Œå…¶å®ç”¨æˆ·å°±æœ‰å¯èƒ½ä¼šæ„Ÿè§‰åˆ°æ˜æ˜¾å¡é¡¿äº†


![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/raf.png#pic_center)

è¯´åˆ°`requestIdleCallback`ï¼Œæ­¤å¤„å°±ä¸å¾—ä¸è°ˆè°ˆ `requestIdleCallback` å’Œ `requestFrameAnimation` çš„åŒºåˆ«ã€‚

åœ¨ä½¿ç”¨ `requestFrameAnimation` çš„æ—¶å€™åˆ©ç”¨ `requestFrameAnimation` çš„è§¦å‘æ—¶æœºï¼ˆä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨ï¼‰ï¼Œé€šå¸¸æ˜¯åšåŠ¨ç”»å¤„ç†ï¼Œæ¯ä¸€å¸§å¯¹ä¸€ä¸ªæ ·å¼ä¿®æ”¹ï¼Œå±äºé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œè€Œ `requestIdleCallback` æ˜¯ç”¨æ¥å¤„ç†ä½ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ä¼šæŠŠä»»åŠ¡pushåˆ°ä¸€ä¸ª `taskQueue` æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´çš„æ—¶å€™ï¼Œæ‰ä¼šè°ƒç”¨ï¼Œæ‰€ä»¥ `requestIdleCallback` è°ƒç”¨çš„æ¬¡æ•°ä¸å¤šï¼Œä½†ä¸€æ¬¡ `requestIdleCallback` ä¼šå®Œæˆå¾ˆå¤šä»»åŠ¡

åœ¨ web é€šä¿¡æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è·¨æ–‡æ¡£é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„ `window.postMessage` ï¼Œå¸¸è¢«ç”¨äºä¸ `iframe` ä¹‹é—´çš„é€šä¿¡ï¼Œä¸€ç§æ˜¯é€šé“é€šä¿¡ä¹Ÿå°±æ˜¯ `MessageChannel`ã€‚

åœ¨æ—©æœŸï¼Œ`react` å›¢é˜Ÿé‡‡ç”¨çš„æ˜¯ `requestAnimationFrame` å’Œ`postMessage` æ¥æ¨¡æ‹Ÿå®ç°çš„ `requestidlecallback` ï¼Œä½†æ˜¯ä¸ºäº†æé«˜æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æµè§ˆå™¨é‡Œï¼Œå½“ `requestAnimationFrame` è¿è¡Œåœ¨åå°æ ‡ç­¾é¡µæˆ–è€…éšè—çš„ `<iframe>` é‡Œæ—¶ï¼Œ`requestAnimationFrame` ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ã€‚å¹¶ä¸”å®ƒçš„è°ƒç”¨æ—¶æœºæ˜¯åœ¨æ¸²æŸ“ä¹‹å‰ï¼Œä½†è¿™ä¸ªæ—¶æœºä¸ç¨³å®šï¼Œæ‰€ä»¥è¿™ä¸ªapiä¹Ÿæ˜¯ä¸ç¨³å®šçš„ã€‚

---

åœ¨ `v16.2.0` ä¹‹åï¼Œ`react` å›¢é˜Ÿé‡‡ç”¨çš„æ˜¯ `MessageChannel` çš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œ`React` æŠŠæ›´æ–°æ“ä½œåšæˆäº†ä¸€ä¸ªä¸ªä»»åŠ¡ï¼Œå¡è¿›äº† `taskQueue`ï¼Œä¹Ÿå°±æ˜¯ä»»åŠ¡åˆ—è¡¨ï¼Œå¦‚æœç›´æ¥éå†æ‰§è¡Œè¿™ä¸ªä»»åŠ¡åˆ—è¡¨ï¼Œçº¯åŒæ­¥æ“ä½œï¼Œæ‰§è¡ŒæœŸé—´ï¼Œæµè§ˆå™¨æ— æ³•å“åº”åŠ¨ç”»æˆ–è€…ç”¨æˆ·çš„è¾“å…¥ï¼Œäºæ˜¯å€ŸåŠ©  `MessageChannel` ï¼Œä¾ç„¶æ˜¯éå†æ‰§è¡Œä»»åŠ¡ï¼Œä½†å½“æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œå°±ä¼šåˆ¤æ–­è¿‡äº†å¤šä¹…ï¼Œå¦‚æœæ²¡æœ‰è¿‡é»˜è®¤çš„åˆ‡ç‰‡æ—¶é—´ï¼ˆ5msï¼‰ï¼Œé‚£å°±å†æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æœè¿‡äº†ï¼Œé‚£å°±è°ƒç”¨ `postMessage`ï¼Œè®©å‡ºçº¿ç¨‹ï¼Œç­‰æµè§ˆå™¨å¤„ç†å®ŒåŠ¨ç”»æˆ–è€…ç”¨æˆ·è¾“å…¥ï¼Œå°±ä¼šæ‰§è¡Œ `onmessage` æ¨å…¥çš„ä»»åŠ¡ï¼Œæ¥ç€éå†æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ã€‚

[react scheduler æºç ](https://github.com/facebook/react/blob/v18.2.0/packages/scheduler/src/forks/Scheduler.js)


## æ”¹è¿›

è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆæ€ä¹ˆç”¨reactæ›´æ–°çš„ç‰¹æ€§æ”¹è¿›æˆ‘ä»¬çš„ä»£ç å‘¢

æˆ‘ä»¬å¯è®¾è®¡ä¸€ä¸ªåˆ©ç”¨ `MessageChannel` è°ƒåº¦ä»»åŠ¡çš„å‡½æ•°ï¼Œå¯ä»¥å°†æ¯æ¬¡å¾ªç¯æ£€æµ‹ç¢°æ’ç»˜åˆ¶è¯æ±‡çš„æ‰§è¡Œå‡½æ•°å³ `handleItem` æ‰“æ–­ï¼Œå¹¶ä¸”å°†è¿”å›çš„ç»“æœé€šè¿‡ `Promise` è¿›è¡ŒåŒ…è£…ï¼Œè€Œä¸”å¦‚æœæ¸²æŸ“çš„æ—¶é—´è¿‡é•¿ï¼Œè¿˜å¯ä»¥ä¸­æ­¢æ¸²æŸ“

å¹¶ä¸”åœ¨å¯¹è¯äº‘å¤„ç†æ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡` è°ƒåº¦å‡½æ•°` è¿”å›çš„ `abort` æ–¹æ³•å°†æ¸²æŸ“ç»ˆæ­¢ï¼Œä½¿è¯äº‘çš„ç»˜åˆ¶æ›´åŠ çµæ´»

```js
/**
 * è°ƒåº¦å‡½æ•°
 * @param {*} handle è¿›è¡Œæ£€æµ‹ç¢°æ’å¹¶ç»˜åˆ¶çš„å‡½æ•°
 */
export default handle => {
  const exec = [];
  return {
    add(task) {
      exec.push(task); // æ¥æ”¶task
    },
    run() {
      const RUNTIME = 16;
      const { port1, port2 } = new MessageChannel();
      let isAbort = false;
      const promise = new Promise((resolve, reject) => {
        const runner = () => {
          const prevTime = performance.now();
          do {
            if (isAbort) { // æ‰“æ–­è°ƒåº¦ä»»åŠ¡å¹¶è¿”å›
              return reject(exec);
            }
            if (!exec.length) { // ä»»åŠ¡å¤„ç†å®Œæˆ
              return resolve(exec);
            }
            const task = exec.shift();
            handle(...task);
          } while (performance.now() - prevTime < RUNTIME);
          port2.postMessage(""); // æ”¾åˆ°ä¸‹ä¸€æ¬¡è°ƒåº¦æ‰§è¡Œ
        };
        port1.onmessage = function () {
          runner(); // æ‰§è¡Œè°ƒåº¦ä»»åŠ¡
        };
        port2.postMessage(""); // è§¦å‘ä»»åŠ¡è°ƒåº¦
      });
      promise.abort = () => {
        isAbort = true;
      };
      return promise;
    },
  };
};
```

æ­¤æ—¶å†çœ‹æˆ‘ä»¬çš„ç«ç„°å›¾ï¼Œæ¯æ¬¡æ‰§è¡Œçš„ `handleItem` è¢«æ‰“æ–­åœ¨ `MessageChannel` ä¸­ï¼Œä¸€æ—¦è¶…è¿‡æ—¢å®šæ—¶é—´å°±ä¼šè®©å‡ºä¸»çº¿ç¨‹ï¼Œåœ¨ä¸‹ä¸€ä¸ª `MessageChannel` ç»§ç»­æ‰§è¡Œï¼Œå°±å¾ˆå®Œç¾

![](https://raw.githubusercontent.com/blazer233/algorithm-learn/main/wordcloud/image/youhua.png#pic_center)

## æ€»ç»“

`React schedule` å‡ºæ¥å¾ˆä¹…äº†ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ–‡ç« ä»‹ç»ï¼Œä½†åœ¨ä¸šåŠ¡ä¸­çœŸæ­£èƒ½ç”¨åˆ°çš„åœ°æ–¹å¾ˆå°‘ã€‚å®ç°ä¸€ä¸ªå¼‚æ­¥è°ƒåº¦å™¨å¾ˆå®¹æ˜“ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæŠ€æœ¯éš¾ç‚¹ï¼Œä½†å¦‚æœèƒ½åŠ©åŠ›åˆ°ä¸šåŠ¡éœ€æ±‚ä¸Šï¼Œå®ƒçš„å¥½å¤„åˆ™ä¸è¨€è€Œå–»ï¼Œå³ä¼˜åŒ–äº†ç”¨æˆ·ä½“éªŒï¼Œåˆå¤¯å®äº†è‡ªèº«æŠ€æœ¯ä¸€ä¸¾ä¸¤å¾—ã€‚

å‚è€ƒæ–‡ç« 

- ğŸ‘‹ï¼š[React ä¹‹ requestIdleCallback æ¥äº†è§£ä¸€ä¸‹](https://juejin.cn/post/7166547963517337614)
- ğŸ‘‹ï¼š[å¼‚æ­¥åˆ†ç‰‡è®¡ç®—åœ¨è…¾è®¯æ–‡æ¡£çš„å®è·µ](https://zhuanlan.zhihu.com/p/570318956)
- ğŸ‘‹ï¼š[å¦‚ä½•å®ç°ä¸€ä¸ªè¯äº‘](https://mp.weixin.qq.com/s/bOrqR7zvZLreBUS1mrNGVg)





